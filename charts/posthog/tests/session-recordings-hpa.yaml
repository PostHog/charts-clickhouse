suite: PostHog session-recordings HPA definition
templates:
  - templates/session-recordings-hpa.yaml

tests:
  - it: should be empty if session-recordings.enabled and session-recordings.hpa.enabled are set to false
    set:
      sessionRecordings.enabled: false
      sessionRecordings.hpa.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should be empty if session-recordings.enabled is true and session-recordings.hpa.enabled is set to false
    set:
      sessionRecordings.enabled: true
      sessionRecordings.hpa.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should be not empty if session-recordings.enabled and session-recordings.hpa.enabled are set to true
    set:
      sessionRecordings.enabled: true
      sessionRecordings.hpa.enabled: true
    asserts:
      - hasDocuments:
          count: 1

  - it: should have the correct apiVersion
    set:
      sessionRecordings.enabled: true
      sessionRecordings.hpa.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isAPIVersion:
          of: autoscaling/v2beta2

  - it: should be the correct kind
    set:
      sessionRecordings.enabled: true
      sessionRecordings.hpa.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: HorizontalPodAutoscaler

  - it: sets hpa spec
    set:
      sessionRecordings.enabled: true
      sessionRecordings:
        hpa:
          enabled: true
          minpods: 2
          maxpods: 10
          cputhreshold: 70
          behavior:
            scaleDown:
              stabilizationWindowSeconds: 3600
    asserts:
      - equal:
          path: spec
          value:
            scaleTargetRef:
              apiVersion: apps/v1
              kind: Deployment
              name: RELEASE-NAME-posthog-session-recordings
            minReplicas: 2
            maxReplicas: 10
            metrics:
              - type: Resource
                resource:
                  name: cpu
                  target:
                    type: Utilization
                    averageUtilization: 70
            behavior:
              scaleDown:
                stabilizationWindowSeconds: 3600
