suite: PostHog web deployment definition
templates:
  - templates/web-deployment.yaml
  - templates/secrets.yaml

tests:
  - it: should be empty if web.enabled is set to false
    template: templates/web-deployment.yaml # TODO: remove once secrets.yaml will be fixed/removed
    set:
      cloud: local # TODO: remove once secrets.yaml will be fixed/removed
      web.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should have the correct apiVersion
    template: templates/web-deployment.yaml # TODO: remove once secrets.yaml will be fixed/removed
    set:
      cloud: local # TODO: remove once secrets.yaml will be fixed/removed
    asserts:
      - hasDocuments:
          count: 1
      - isAPIVersion:
          of: apps/v1

  - it: should be the correct kind
    template: templates/web-deployment.yaml # TODO: remove once secrets.yaml will be fixed/removed
    set:
      cloud: local # TODO: remove once secrets.yaml will be fixed/removed
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Deployment

  - it: spec.template.spec.containers[0].env should have the default statsd env variables when `prometheus-statsd-exporter.enabled` is `true`
    template: templates/web-deployment.yaml # TODO: remove once secrets.yaml will be fixed/removed
    set:
      cloud: local # TODO: remove once secrets.yaml will be fixed/removed
      prometheus-statsd-exporter.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: STATSD_HOST
            value: RELEASE-NAME-posthog-prometheus-statsd-exporter
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: STATSD_PORT
            value: "9125"

  - it: spec.template.spec.containers[0].env should have custom statsd env variables when `prometheus-statsd-exporter.enabled` is `true` port is custom
    template: templates/web-deployment.yaml # TODO: remove once secrets.yaml will be fixed/removed
    set:
      cloud: local # TODO: remove once secrets.yaml will be fixed/removed
      prometheus-statsd-exporter.enabled: true
      prometheus-statsd-exporter.statsd.tcpPort: 1234
    asserts:
      - hasDocuments:
          count: 1
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: STATSD_HOST
            value: RELEASE-NAME-posthog-prometheus-statsd-exporter
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: STATSD_PORT
            value: "1234"

  - it: spec.template.spec.containers[0].env should have custom statsd env variables when `externalStatsd` is configured
    template: templates/web-deployment.yaml # TODO: remove once secrets.yaml will be fixed/removed
    set:
      cloud: local # TODO: remove once secrets.yaml will be fixed/removed
      externalStatsd:
        host: statsd.example.com
        port: "5678"
    asserts:
      - hasDocuments:
          count: 1
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: STATSD_HOST
            value: statsd.example.com
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: STATSD_PORT
            value: "5678"
